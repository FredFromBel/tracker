<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Clear365 – Tracker privé</title>
    <style>
      body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
      h1 { margin-bottom: 8px; }
      .muted { color: #555; }
      .grid { display: grid; grid-template-columns: repeat(6, minmax(160px, 1fr)); gap: 10px; margin-top: 14px; }
      .grid > div { display: flex; flex-direction: column; gap: 6px; }
      label { font-size: 13px; color: #333; }
      input, textarea, button { padding: 8px; font-size: 14px; }
      textarea { min-height: 38px; resize: vertical; }
      .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-top: 10px; }
      button { cursor: pointer; }
      .pill { display:inline-block; padding: 6px 10px; border: 1px solid #ddd; border-radius: 999px; font-size: 13px; }
      .ok { border-color: #9ad19a; }
      .err { border-color: #e6a0a0; }
      table { border-collapse: collapse; width: 100%; margin-top: 18px; }
      th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; }
      th { background: #f6f6f6; text-align: left; }
      .right { text-align: right; }
      details { margin-top: 16px; }
      pre { background: #f6f6f6; padding: 12px; overflow: auto; }
      .small { font-size: 12px; color: #666; }

      /* Charts */
      .charts { display: grid; grid-template-columns: repeat(3, minmax(240px, 1fr)); gap: 12px; margin-top: 16px; }
      .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; }
      .card h3 { margin: 0 0 8px 0; font-size: 14px; }
      canvas { width: 100%; height: 140px; border: 1px solid #eee; border-radius: 8px; }
      .legend { display:flex; gap:10px; margin-top:8px; font-size:12px; color:#666; flex-wrap:wrap; }
      .kpi { font-size: 12px; color:#666; margin-top:6px; }
    </style>
  </head>
  <body>
    <h1>Tracker privé</h1>
    <p class="muted">
      Vue: 7 derniers jours (Table Storage).
      <a href="/.auth/me">/.auth/me</a> —
      <a href="/.auth/logout">Logout</a>
    </p>

    <div class="row">
      <span class="pill" id="status">Prêt</span>
      <button id="refresh">Rafraîchir la liste</button>
    </div>

    <!-- Charts -->
    <div class="charts">
      <div class="card">
        <h3>Poids (kg) — 7 jours</h3>
        <canvas id="cWeight" width="900" height="280"></canvas>
        <div class="kpi" id="kpiWeight"></div>
      </div>
      <div class="card">
        <h3>Sommeil MyAir (%) — 7 jours</h3>
        <canvas id="cSleep" width="900" height="280"></canvas>
        <div class="kpi" id="kpiSleep"></div>
      </div>
      <div class="card">
        <h3>Score /10 — 7 jours</h3>
        <canvas id="cScore" width="900" height="280"></canvas>
        <div class="kpi" id="kpiScore"></div>
      </div>
    </div>

    <h2 style="margin-top:16px;">Saisie du jour</h2>

    <div class="grid">
      <div>
        <label>Date (YYYY-MM-DD)</label>
        <input id="date" />
        <div class="small">Par défaut: aujourd’hui</div>
      </div>

      <div>
        <label>Poids (kg)</label>
        <input id="weightKg" type="number" step="0.1" placeholder="108.5" />
      </div>

      <div>
        <label>Sommeil MyAir (%)</label>
        <input id="sleepPct" type="number" min="0" max="100" step="1" placeholder="85" />
      </div>

      <div>
        <label>Score /10</label>
        <input id="dayScore" type="number" min="0" max="10" step="1" placeholder="9" />
      </div>

      <div>
        <label>Jeûne 23/1</label>
        <input id="fasting231" type="checkbox" />
        <div class="small">Coché = oui</div>
      </div>

      <div>
        <label>Muscu (séance)</label>
        <input id="strength" type="checkbox" />
        <div class="small">Coché = oui</div>
      </div>

      <div>
        <label>Pompes</label>
        <input id="pushUps" type="number" min="0" step="1" placeholder="100" />
      </div>

      <div>
        <label>Squats</label>
        <input id="squats" type="number" min="0" step="1" placeholder="100" />
      </div>

      <div>
        <label>Rows barre</label>
        <input id="barbellRows" type="number" min="0" step="1" placeholder="100" />
      </div>

      <div>
        <label>Rameur (min)</label>
        <input id="rowerMin" type="number" min="0" step="1" placeholder="25" />
      </div>

      <div>
        <label>Énergie (1–5)</label>
        <input id="energyScore" type="number" min="0" max="5" step="1" placeholder="0" />
        <div class="small">Optionnel</div>
      </div>

      <div>
        <label>Stress (1–5)</label>
        <input id="stressScore" type="number" min="0" max="5" step="1" placeholder="0" />
        <div class="small">Optionnel</div>
      </div>

      <div style="grid-column: span 3;">
        <label>Repas</label>
        <textarea id="mealNotes" placeholder="Soupe + omelette…"></textarea>
      </div>

      <div style="grid-column: span 3;">
        <label>Notes</label>
        <textarea id="notes" placeholder="Phase 1, sensations, remarques…"></textarea>
      </div>
    </div>

    <div class="row">
      <button id="save">Enregistrer (upsert)</button>
      <span class="small">Enregistre/écrase la journée sélectionnée.</span>
    </div>

    <h2 style="margin-top:22px;">Liste (7 derniers jours)</h2>

    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th class="right">Poids (kg)</th>
          <th class="right">Sommeil (%)</th>
          <th class="right">Pompes</th>
          <th class="right">Squats</th>
          <th class="right">Rows</th>
          <th class="right">Rameur (min)</th>
          <th class="right">Score /10</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="9">Chargement…</td></tr>
      </tbody>
    </table>

    <details>
      <summary>Debug (réponses brutes)</summary>
      <pre id="raw"></pre>
    </details>

    <script>
      const statusEl = document.getElementById("status");
      const rawEl = document.getElementById("raw");
      const rowsEl = document.getElementById("rows");

      const cWeight = document.getElementById("cWeight");
      const cSleep = document.getElementById("cSleep");
      const cScore = document.getElementById("cScore");
      const kpiWeight = document.getElementById("kpiWeight");
      const kpiSleep = document.getElementById("kpiSleep");
      const kpiScore = document.getElementById("kpiScore");

      function setStatus(text, kind) {
        statusEl.textContent = text;
        statusEl.className = "pill " + (kind || "");
      }

      function todayISO() {
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        return `${yyyy}-${mm}-${dd}`;
      }

      function num(id) {
        const v = document.getElementById(id).value;
        if (v === "" || v === null || v === undefined) return undefined;
        const n = Number(v);
        return Number.isFinite(n) ? n : undefined;
      }

      function bool(id) {
        return !!document.getElementById(id).checked;
      }

      function clearCanvas(canvas) {
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        return ctx;
      }

      function drawLineChart(canvas, labels, values, yMin, yMax) {
        const ctx = clearCanvas(canvas);
        const W = canvas.width, H = canvas.height;

        // Frame
        ctx.strokeStyle = "#e6e6e6";
        ctx.lineWidth = 1;
        ctx.strokeRect(0.5, 0.5, W - 1, H - 1);

        // If no data
        const clean = values.map(v => (typeof v === "number" && isFinite(v)) ? v : null).filter(v => v !== null);
        if (clean.length === 0) {
          ctx.fillStyle = "#777";
          ctx.font = "14px system-ui, Arial";
          ctx.fillText("Aucune donnée", 12, 24);
          return;
        }

        // Auto scale if not provided
        if (yMin === null || yMax === null) {
          const minV = Math.min(...clean);
          const maxV = Math.max(...clean);
          const pad = (maxV - minV) === 0 ? 1 : (maxV - minV) * 0.15;
          yMin = minV - pad;
          yMax = maxV + pad;
        }

        const padL = 46, padR = 10, padT = 10, padB = 28;
        const innerW = W - padL - padR;
        const innerH = H - padT - padB;

        function x(i) {
          if (labels.length === 1) return padL + innerW / 2;
          return padL + (i * innerW) / (labels.length - 1);
        }
        function y(v) {
          const t = (v - yMin) / (yMax - yMin);
          return padT + innerH - t * innerH;
        }

        // Grid (3 lines)
        ctx.strokeStyle = "#f0f0f0";
        ctx.lineWidth = 1;
        for (let g = 1; g <= 3; g++) {
          const yy = padT + (g * innerH) / 4;
          ctx.beginPath();
          ctx.moveTo(padL, yy);
          ctx.lineTo(padL + innerW, yy);
          ctx.stroke();
        }

        // Y axis labels (min/max)
        ctx.fillStyle = "#666";
        ctx.font = "12px system-ui, Arial";
        ctx.fillText(String(Math.round(yMax * 10) / 10), 8, padT + 12);
        ctx.fillText(String(Math.round(yMin * 10) / 10), 8, padT + innerH);

        // Line
        ctx.strokeStyle = "#111";
        ctx.lineWidth = 2;
        ctx.beginPath();
        let started = false;
        for (let i = 0; i < labels.length; i++) {
          const v = values[i];
          if (typeof v !== "number" || !isFinite(v)) continue;
          const xx = x(i), yy = y(v);
          if (!started) { ctx.moveTo(xx, yy); started = true; }
          else { ctx.lineTo(xx, yy); }
        }
        ctx.stroke();

        // Points + x labels
        ctx.fillStyle = "#111";
        for (let i = 0; i < labels.length; i++) {
          const v = values[i];
          const xx = x(i);
          if (typeof v === "number" && isFinite(v)) {
            const yy = y(v);
            ctx.beginPath();
            ctx.arc(xx, yy, 3, 0, Math.PI * 2);
            ctx.fill();
          }
          // x label (DD/MM)
          const lab = labels[i];
          ctx.fillStyle = "#666";
          ctx.font = "11px system-ui, Arial";
          ctx.fillText(lab, xx - 14, H - 10);
          ctx.fillStyle = "#111";
        }
      }

      function fmtDDMM(isoDate) {
        // iso: YYYY-MM-DD
        if (!isoDate || isoDate.length < 10) return "";
        const dd = isoDate.slice(8,10);
        const mm = isoDate.slice(5,7);
        return `${dd}/${mm}`;
      }

      function calcDelta(first, last) {
        if (typeof first !== "number" || typeof last !== "number") return "";
        const d = last - first;
        const sign = d > 0 ? "+" : "";
        return `${sign}${Math.round(d * 10) / 10}`;
      }

      function updateCharts(itemsAsc) {
        // itemsAsc: oldest -> newest
        const labels = itemsAsc.map(it => fmtDDMM(it.Date));
        const w = itemsAsc.map(it => (it.WeightKg === undefined || it.WeightKg === null) ? null : Number(it.WeightKg));
        const s = itemsAsc.map(it => (it.SleepPct === undefined || it.SleepPct === null) ? null : Number(it.SleepPct));
        const sc = itemsAsc.map(it => (it.DayScore === undefined || it.DayScore === null) ? null : Number(it.DayScore));

        drawLineChart(cWeight, labels, w, null, null);
        drawLineChart(cSleep, labels, s, 0, 100);
        drawLineChart(cScore, labels, sc, 0, 10);

        const wClean = w.filter(v => typeof v === "number" && isFinite(v));
        const sClean = s.filter(v => typeof v === "number" && isFinite(v));
        const scClean = sc.filter(v => typeof v === "number" && isFinite(v));

        if (wClean.length >= 2) {
          kpiWeight.textContent = `Δ 7j: ${calcDelta(wClean[0], wClean[wClean.length - 1])} kg`;
        } else {
          kpiWeight.textContent = "";
        }
        if (sClean.length >= 1) {
          kpiSleep.textContent = `Dernier: ${Math.round(sClean[sClean.length - 1])}%`;
        } else {
          kpiSleep.textContent = "";
        }
        if (scClean.length >= 1) {
          kpiScore.textContent = `Dernier: ${Math.round(scClean[scClean.length - 1])}/10`;
        } else {
          kpiScore.textContent = "";
        }
      }

      async function loadList() {
        setStatus("Chargement…");
        const res = await fetch(`/api/checkins?days=7`, { headers: { "Accept": "application/json" }});
        const data = await res.json();
        rawEl.textContent = JSON.stringify({ list: data }, null, 2);

        rowsEl.innerHTML = "";
        if (!data.ok || !Array.isArray(data.items) || data.items.length === 0) {
          rowsEl.innerHTML = `<tr><td colspan="9">Aucune donnée</td></tr>`;
          setStatus("OK (0)", "ok");
          updateCharts([]); // clears
          return;
        }

        // API returns latest first; build ASC for charts
        const itemsDesc = data.items;
        const itemsAsc = [...itemsDesc].reverse();

        // Table
        for (const it of itemsDesc) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${it.Date ?? ""}</td>
            <td class="right">${it.WeightKg ?? ""}</td>
            <td class="right">${it.SleepPct ?? ""}</td>
            <td class="right">${it.PushUps ?? ""}</td>
            <td class="right">${it.Squats ?? ""}</td>
            <td class="right">${it.BarbellRows ?? ""}</td>
            <td class="right">${it.RowerMin ?? ""}</td>
            <td class="right">${it.DayScore ?? ""}</td>
            <td>${it.Notes ?? ""}</td>
          `;
          rowsEl.appendChild(tr);
        }

        updateCharts(itemsAsc);
        setStatus("OK (" + data.items.length + ")", "ok");
      }

      async function saveToday() {
        try {
          setStatus("Enregistrement…");
          const payload = {
            date: document.getElementById("date").value || todayISO(),
            weightKg: num("weightKg"),
            sleepPct: num("sleepPct"),
            dayScore: num("dayScore"),
            fasting231: bool("fasting231"),
            strength: bool("strength"),
            pushUps: num("pushUps"),
            squats: num("squats"),
            barbellRows: num("barbellRows"),
            rowerMin: num("rowerMin"),
            energyScore: num("energyScore"),
            stressScore: num("stressScore"),
            mealNotes: document.getElementById("mealNotes").value || "",
            notes: document.getElementById("notes").value || ""
          };

          const res = await fetch(`/api/checkins`, {
            method: "PUT",
            headers: { "Content-Type": "application/json", "Accept": "application/json" },
            body: JSON.stringify(payload)
          });

          const data = await res.json();
          rawEl.textContent = JSON.stringify({ save: data }, null, 2);

          if (!res.ok || !data.ok) {
            setStatus("Erreur save", "err");
            return;
          }

          setStatus("Enregistré", "ok");
          await loadList();
        } catch (e) {
          rawEl.textContent = String(e);
          setStatus("Erreur JS", "err");
        }
      }

      // init defaults
      document.getElementById("date").value = todayISO();

      document.getElementById("refresh").addEventListener("click", loadList);
      document.getElementById("save").addEventListener("click", saveToday);

      loadList();
    </script>
  </body>
</html>
